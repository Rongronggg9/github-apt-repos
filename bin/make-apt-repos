#!/usr/bin/python3
"""
Make apt repositories from *.deb's separated by architecture and component.
"""

import sys
import os
import re
import pprint
import subprocess
import logging

logger = logging.getLogger(os.path.splitext(os.path.basename(__file__))[0])

DEB_BASENAME_RE = r'{package}([-_\.](?P<dist>.+)|)_{version}_{arch}'


def collect_dists_archs(dir=os.curdir):
    """
    Group packages by dist and architecture.

    Assumes the following package filename format:
    
    'package-dist_version_arch.deb' 
    """
    dists = {}
    # TODO Use subprocess.Popen to stream results for large collections
    for deb in subprocess.run(
            ['find', '.', '-iname', '*.deb'],
            check=True, stdout=subprocess.PIPE,
            encoding=sys.stdout.encoding
    ).stdout.strip().split('\n'):
        arch = subprocess.run(
            ['dpkg-deb', '-f', deb, 'Architecture'], check=True,
            stdout=subprocess.PIPE, encoding=sys.stdout.encoding
        ).stdout.strip()
        package = subprocess.run(
            ['dpkg-deb', '-f', deb, 'Package'], check=True,
            stdout=subprocess.PIPE, encoding=sys.stdout.encoding
        ).stdout.strip()
        version = subprocess.run(
            ['dpkg-deb', '-f', deb, 'Version'], check=True,
            stdout=subprocess.PIPE, encoding=sys.stdout.encoding
        ).stdout.strip()
        deb_basename_match = re.match(
            DEB_BASENAME_RE.format(
                arch=arch, package=package, version=version),
            os.path.splitext(os.path.basename(deb))[0])
        dist = deb_basename_match.group(2)
        dists.setdefault(dist, {}).setdefault(arch, []).append(deb)
    return dists


def main():
    """
    Make apt repositories from *.deb's separated by architecture and component.
    """
    dists = collect_dists_archs()
    for dist, archs in dists.items():
        path = 'apt'
        if dist is not None:
            path = os.path.join(path, dist)
        for arch, debs in archs.items():
            arch_path = os.path.join(path, arch)
            os.makedirs(arch_path, exist_ok=True)
            packages = open(os.path.join(arch_path, 'Packages'), 'w')
            for deb in debs:
                logger.info('Writing %r', packages.name)
                subprocess.run(
                    ['dpkg-scanpackages', '-m', deb, '/dev/null'], check=True,
                    stdout=packages)


if __name__ == '__main__':
    logging.basicConfig(level=logging.INFO)
    pprint.pprint(main())
