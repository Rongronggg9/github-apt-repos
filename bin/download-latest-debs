#!/bin/sh
# Download all the *.deb files for the latest release

set -xe


gh_get_latest_release_url() {
    # Get the latest release redirect target URL
    gh_repo_path="$1"

    # workaround the fact that wget won't do recursive downloding on
    # the redirect target

    # TODO stop wget writing the file while still getting access to
    # the redirect Location
    gh_latest_release_url=$(
	wget "https://github.com/$gh_repo_path/releases/latest" 2>&1 |
	    grep '^Location:' | tail -n 1)
    # Strip the wget prefix and suffix
    gh_latest_release_url=${gh_latest_release_url#Location: }
    echo ${gh_latest_release_url% \[following\]}
}


main() {
    # Download all the *.deb files for the latest release
    # Take the GitHub repo path on stdin
    read gh_repo_path

    # TODO replace with GitHub API usage
    $DEBUG wget -r -nH --cut-dirs=2 -e robots=off -c \
	   -l 1 -A deb "$(gh_get_latest_release_url "$gh_repo_path")"
}

main
